![alt text](logo-teal.png "FastAPI")

# FASTAPI BASE

## Introduction
**Back-end sử dụng FastAPI cho project sharing youtube app**  
**Base code đã được cấu hình sẵn:**
- FastAPI
- Postgres
- Alembic
- Authen/Author với JWT
- Logging
- Pytest  

**Các tính năng trong app:**
- API login, register
- API config user cho admin
- API get, create video youtube, lấy title và description từ youtube
- Pagination
- Websocket để thông báo real time khi người dùng thêm 1 video mới

## Installation
**Cách 1:**
- Clone Project
- Tạo venv
- Cài đặt requirements.txt
- Run project ở cổng 8000
```
// Clone project & run
$ git clone https://github.com/Oibanoi/Youtube-Sharing-BE.git
$ cd Youtube-Sharing-BE
```
- Tạo venv 
1.  Trên windows
```
$ python -m venv .venv
$ .venv\Scripts\activate
```
2. Trên linux
```
$ python3 -m venv .venv
$ source .venv/bin/activate
```
- Cài đặt thư viện và cấu hình env
```
$ pip install -r requirements.txt
$ cp env.example .env       // Recheck SQL_DATABASE_URL ở bước này
$ alembic upgrade head
$ uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```
**Cách 2:** Dùng Docker & Docker Compose 
- Clone Project
- Run docker-compose
```
$ git clone https://github.com/Oibanoi/Youtube-Sharing-BE.git
$ cd Youtube-Sharing-BE
$ docker-compose up -d
```

## Cấu trúc project
```
.  
├── alembic  
│   ├── versions    // thư mục chứa file migrations  
│   └── env.py  
├── app  
│   ├── api         // các file api được đặt trong này  
│   ├── core        // chứa file config load các biến env & function tạo/verify JWT access-token  
│   ├── db          // file cấu hình make DB session  
│   ├── helpers     // các function hỗ trợ như login_manager, paging  
│   ├── models      // Database model, tích hợp với alembic để auto generate migration  
│   ├── schemas     // Pydantic Schema  
│   ├── services    // Chứa logic CRUD giao tiếp với DB  
│   └── main.py     // cấu hình chính của toàn bộ project  
├── tests  
│   ├── api         // chứa các file test cho từng api  
│   ├── faker       // chứa file cấu hình faker để tái sử dụng  
│   ├── .env        // config DB test  
│   └── conftest.py // cấu hình chung của pytest  
├── .gitignore  
├── alembic.ini  
├── docker-compose.yaml  
├── Dockerfile  
├── env.example  
├── logging.ini     // cấu hình logging  
├── postgresql.conf // file cấu hình postgresql, sử dụng khi run docker-compose  
├── pytest.ini      // file setup cho pytest  
├── README.md  
└── requirements.txt    // file chứa các thư viện để cài đặt qua pip install
```


## Migration
Migration là một tính năng cho phép bạn thay đổi cả cấu trúc và dữ liệu trong database.

Thay vì thay đổi trực tiếp vào database thì project FastAPI này sử dụng alembic để thực hiện việc thay đổi các table

**File migration - SAMPLE**
```
# alembic/versions/f9a075ca46e9_.py

...
def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('user',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('full_name', sa.String(), nullable=True),
    sa.Column('email', sa.String(), nullable=True),
    sa.Column('hashed_password', sa.String(length=255), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_user_email'), 'user', ['email'], unique=True)
    op.create_index(op.f('ix_user_full_name'), 'user', ['full_name'], unique=False)
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_user_full_name'), table_name='user')
    op.drop_index(op.f('ix_user_email'), table_name='user')
    op.drop_table('user')
    # ### end Alembic commands ###
...
```

**Lưu ý:**   
Setup database để chạy local bằng alembic

```
$ alembic upgrade head
```
Mỗi khi thay đổi DB, ta cần thay đổi các model trong folder app/models 
```
$ alembic revision --autogenerate 
$ alembic upgrade head
```



## Unit Test



## Deploy bằng docker
1. Build the docker image
```
$ docker build -t sharing-yt .
```
2. Rename to push iamge to docker hub
```
$ docker tag sharing-yt huupb/sharing-yt:1.0
$ docker push huupb/sharing-yt:1.0
```